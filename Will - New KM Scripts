-- Set the job order number
UPDATE EIH_KM_PARAMETER
SET 
SOURCE_TABLE_NAME = TRIM(EIH_KM_PARAMETER.SOURCE_TABLE_NAME),
TARGET_TABLE_NAME = TRIM(EIH_KM_PARAMETER.TARGET_TABLE_NAME),
SOURCE_KEY_PART_1 = CASE WHEN SOURCE_KEY_PART_1 IS NULL OR SOURCE_KEY_PART_1 = '''NULL''' OR SOURCE_KEY_PART_1 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_1) END,
SOURCE_KEY_PART_2 = CASE WHEN SOURCE_KEY_PART_2 IS NULL OR SOURCE_KEY_PART_2 = '''NULL''' OR SOURCE_KEY_PART_2 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_2) END,
SOURCE_KEY_PART_3 = CASE WHEN SOURCE_KEY_PART_3 IS NULL OR SOURCE_KEY_PART_3 = '''NULL''' OR SOURCE_KEY_PART_3 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_3) END,
SOURCE_KEY_PART_4 = CASE WHEN SOURCE_KEY_PART_4 IS NULL OR SOURCE_KEY_PART_4 = '''NULL''' OR SOURCE_KEY_PART_4 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_4) END,
SOURCE_KEY_PART_5 = CASE WHEN SOURCE_KEY_PART_5 IS NULL OR SOURCE_KEY_PART_5 = '''NULL''' OR SOURCE_KEY_PART_5 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_5) END,
SOURCE_SYSTEM_NAME = TRIM(EIH_KM_PARAMETER.SOURCE_SYSTEM_NAME),
SOURCE_DOMAIN_NAME = TRIM(EIH_KM_PARAMETER.SOURCE_DOMAIN_NAME),
JOB_ORDER_NO = src.NEW_JOB_ORDER_NO
FROM
(
SELECT km.SOURCE_DOMAIN_NAME, km.SOURCE_TABLE_NAME, km.TARGET_TABLE_NAME, ROW_NUMBER() OVER (PARTITION BY km.TARGET_TABLE_NAME, SUBSTRING(km.SOURCE_DOMAIN_NAME FROM 1 FOR 3) ORDER BY
       km.SOURCE_TABLE_NAME ASC) AS NEW_JOB_ORDER_NO FROM
(SELECT SOURCE_DOMAIN_NAME, SOURCE_TABLE_NAME, TARGET_TABLE_NAME FROM EIH_KM_PARAMETER WHERE LAYER_CODE = 'CDS' AND TARGET_TABLE_NAME IN (SELECT TARGET_TABLE_NAME
       FROM EIH_KM_PARAMETER WHERE LAYER_CODE = 'CDS' GROUP BY 1 HAVING COUNT(*) > 1)) km
) src
WHERE EIH_KM_PARAMETER.SOURCE_DOMAIN_NAME = src.SOURCE_DOMAIN_NAME AND EIH_KM_PARAMETER.SOURCE_TABLE_NAME = src.SOURCE_TABLE_NAME AND
EIH_KM_PARAMETER.TARGET_TABLE_NAME = src.TARGET_TABLE_NAME
;
-- Set the rest to the proper null
UPDATE EIH_KM_PARAMETER
SET
SOURCE_KEY_PART_1 = CASE WHEN SOURCE_KEY_PART_1 IS NULL OR SOURCE_KEY_PART_1 = '''NULL''' OR SOURCE_KEY_PART_1 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_1) END,
SOURCE_KEY_PART_2 = CASE WHEN SOURCE_KEY_PART_2 IS NULL OR SOURCE_KEY_PART_2 = '''NULL''' OR SOURCE_KEY_PART_2 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_2) END,
SOURCE_KEY_PART_3 = CASE WHEN SOURCE_KEY_PART_3 IS NULL OR SOURCE_KEY_PART_3 = '''NULL''' OR SOURCE_KEY_PART_3 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_3) END,
SOURCE_KEY_PART_4 = CASE WHEN SOURCE_KEY_PART_4 IS NULL OR SOURCE_KEY_PART_4 = '''NULL''' OR SOURCE_KEY_PART_4 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_4) END,
SOURCE_KEY_PART_5 = CASE WHEN SOURCE_KEY_PART_5 IS NULL OR SOURCE_KEY_PART_5 = '''NULL''' OR SOURCE_KEY_PART_5 = 'NULL' THEN '\\\''NULL\\\''' ELSE TRIM(SOURCE_KEY_PART_5) END
WHERE LAYER_CODE = 'CDS';
;
-- EIH_JOB Script to be run after EIH_KM_PARAMETER
UPDATE EIH_JOB
SET JOB_ORDER_NO = src.JOB_ORDER_NO,
SOURCE_DOMAIN_NAME = TRIM(EIH_JOB.SOURCE_DOMAIN_NAME)
FROM (
SELECT JOB_ORDER_NO, TARGET_TABLE_NAME, SOURCE_DOMAIN_NAME FROM EIH_KM_PARAMETER km WHERE km.LAYER_CODE = 'CDS'
) src
WHERE EIH_JOB.SOURCE_DOMAIN_NAME = src.SOURCE_DOMAIN_NAME AND EIH_JOB.LAYER_CODE = 'CDS';
;
SELECT * FROM EIH_KM_PARAMETER;
SELECT * FROM EIH_JOB WHERE EIH_JOB.LAYER_CODE = 'CDS'
and ACTIVE_IND = 'Y';
